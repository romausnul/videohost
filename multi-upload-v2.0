multiUpload=new function(){var e=this,r={downloadsCount:1,threadsCount:10,getUploadDataUrl:undefined,getVideoLinkUrl:undefined,multiUploadTemplateSelector:undefined,zclipPath:undefined,updateVideoUrl:undefined,maxUploadFileSize:1073741824,maxUploadFileSizeMb:1024},i,v;e.Init=function(n){r=$.extend(r,n);$(window).on("resize",function(){setTimeout(function(){$(".js-copy-link-container .zclip").css({left:"0px",top:"0px"})},0)})};i={threadIndex:0,multiUploadBlock:$(".js-multi-upload-block"),standartUploadBlock:$(".js-standart-upload-block"),copyLinkBlock:$(".js-copy-link-window"),multiUploadTemplate:$($("#multi-upload-template").html()),uploadWaitTemplate:$($("#upload-wait-template").html()),uploadFinishedTemplate:$($("#upload-finished-template").html()),uploadDeletedTemplate:$($("#upload-deleted-template").html()),uploadErrorTemplate:$($("#upload-error-template").html()),standartUploadForm:$($("#standart-upload-form-template").html()),totalRecived:0};e.isHTML5Upload=function(){return typeof XMLHttpRequest=="undefined"||typeof FileReader=="undefined"?!1:!0};var t={unstarted:0,started:1,complete:2,error:3,deleted:4},p=function(n){var i={file:n,name:undefined,size:0,uploadUrl:undefined,uploadId:undefined,uploaded:!1,status:t.unstarted,percent:0,startDate:undefined,xhr:undefined},r,u,f;return e.isHTML5Upload()?(i.name=n.name,i.size=n.size):(r=n.val(),u=r.match(/[-_\s\.\w]+[\.][\w]+$/i),u?i.name=u[0]:(f=r.lastIndexOf("\\"),i.name=f>=0?r.slice(f+1):r)),i},a={},u={},o=e.isHTML5Upload()?a:u,n=[],nt=$(".js-upload-watcher"),tt=$(".js-total-label"),it=$(".js-uploaded-label"),rt=$(".js-total-errors-label");if(nt.bind({change:function(){e.isHTML5Upload()&&o.uploadFiles(this.files)},click:function(n){e.isHTML5Upload()||(n.preventDefault(),o.uploadFiles())}}),e.isHTML5Upload()){$.fn.draghover=function(){return this.each(function(){var n=$(),t=$(this);t.on("dragenter",function(i){i=i||window.event;i.preventDefault();n.length===0&&t.trigger("draghoverstart");n=n.add(i.target)});t.on("dragleave drop",function(i){i=i||window.event;i.preventDefault();n=n.not(i.target);n.length===0&&t.trigger("draghoverend")})})};window.ondrop=function(n){n=n||window.event;n.preventDefault();$(".js-drop-panel").addClass("nodisplay");o.uploadFiles(n.dataTransfer.files)};window.ondragover=function(n){n=n||window.event;n.preventDefault()};$(window).draghover().on({draghoverstart:function(){$(".js-drop-panel").removeClass("nodisplay")},draghoverend:function(){$(".js-drop-panel").addClass("nodisplay")}})}i.multiUploadBlock.on("click",".js-edit-name-btn",function(){var n=$(this).parents(".js-video-upload"),t;n.find(".js-file-name").hide();n.find(".js-file-name-input-container").show();t=n.find(".js-file-name-container").text();n.find(".js-file-name-input").val(t).focus().select()});i.multiUploadBlock.on("click",".js-upload-restore-btn",function(){var n=$(this).parents(".js-video-upload"),t=n.attr("id"),i=parseInt(t.substring(6));ft(i)});i.multiUploadBlock.on("click",".js-confirm-name-btn",function(){var n=$(this).parents(".js-video-upload"),t=n.attr("id"),i=parseInt(t.substring(6)),r=n.find(".js-file-name-input").val();d(i,r)});i.multiUploadBlock.on("keypress",".js-file-name-input",function(n){if(n.which==13){var t=$(this).parents(".js-video-upload"),i=t.attr("id"),r=parseInt(i.substring(6)),u=t.find(".js-file-name-input").val();d(r,u)}});i.multiUploadBlock.on("click",".js-cancel",function(){var r=$(this).parents(".js-video-upload"),u=r.attr("id"),i=parseInt(u.substring(6));switch(r.attr("data-type")){case"wait":n[i].status=t.deleted;s(i);break;case"finish":n[i].status=t.deleted;s(i);break;case"error":n[i].status=t.deleted;s(i);break;case"upload":o.cancelUpload(i)}});i.copyLinkBlock.on("click",".js-close",function(){i.multiUploadBlock.find(".js-copy-tooltip").fadeOut("fast");i.copyLinkBlock.hide("fast")});v=function(n){var t=$.Deferred();return typeof n=="object"?$.ajax({type:"get",url:r.getUploadDataUrl+"?r="+Math.floor(Math.random(1,1e7)*1e7),success:function(i){n.uploadId=i.uploadId;n.uploadUrl=(i.uploadUrl[i.uploadUrl.length-1]=="/"?i.uploadUrl.substring(0,i.uploadUrl.length-1):i.uploadUrl)+"/api/upload";t.resolve()},error:function(){t.resolve()}}):t.resolve(),t.promise()};a=$.extend(a,{uploadFiles:function(u){var f,e,a;if(!u.length)return!1;try{yaCounter18545545&&yaCounter18545545.reachGoal&&yaCounter18545545.reachGoal("main_dl")}catch(k){}for(var s=n.length,b=s+u.length>r.threadsCount?r.threadsCount-s:u.length,c=[],w=0,v=0,f=0;f<n.length;f++)n[f].status==t.started&&w++;for(f=0;f<b;++f)e=u[f],a=new p(e),n.push(a),e.size>r.maxUploadFileSize?(v++,a.status=t.error,h(s+f,a.name,!0)):f-v+w<r.downloadsCount?(l(s+f,e.name,e.size),c.push(s+f)):y(s+f,e.name,e.size);if(n.length==v)return $(".js-maximum-size").hide(),$("#alert").show(),!1;for($(".js-main-content").hide(),$(".js-multi-upload").show(),$("#main-wrapper").removeClass("main"),$(".footer").removeClass("main"),f=0;f<c.length;f++)o.uploadFile(c[f]),i.threadIndex=c[f];return!0},uploadFile:function(u){var e=n[u],o;if(e.size>r.maxUploadFileSize)return e.status=t.error,h(u,e.name,!0),f(),!1;e.status=t.started;l(u,e.name,e.size);o=v(e);o.done(function(){var n,r,o;e.startDate=new Date;n=new XMLHttpRequest;e.xhr=n;r=0;n.upload.addEventListener("progress",function(n){if(n.lengthComputable){i.totalRecived+=n.loaded-r;r=n.loaded;var t=n.loaded*100/n.total;w(e.name,u,t,n.total)}},!1);n.upload.addEventListener("error",function(){e.status=t.error;h(u,e.name);f()});n.onreadystatechange=function(){this.readyState==4&&(this.status==200?(e.status=t.complete,e.uploaded=!0,b(u,e.size,e.uploadId)):(e.status=t.error,h(u,e.name),f()))};o=new FormData;o.append("thefile",e.file);n.open("post",e.uploadUrl+"?id="+e.uploadId);n.send(o)})},cancelUpload:function(i){n[i].xhr.abort();n[i].status=t.deleted;s(i);f()}});u=$.extend(u,{uploadFiles:function(){var f=n.length,t,r,i;$(".js-main-content").hide();$(".js-multi-upload").show();$("#main-wrapper").removeClass("main");$(".footer").removeClass("main");t=u._prepareForm(f);/Safari/i.test(navigator.userAgent)?(r=t.find(".js-standart-file-input")[0],i=document.createEvent("MouseEvents"),i.initMouseEvent("click",!0,!0,window),r.dispatchEvent(i)):t.find(".js-standart-file-input").click()},_prepareForm:function(n){var r=$("#video-iframe-"+n),t;if(r.length||(r=$("<iframe />").attr({name:"video-iframe-"+n,id:"video-iframe-"+n}),i.standartUploadBlock.append(r)),t=$("#video-form-"+n),!t.length){t=i.standartUploadForm.clone().attr({id:"video-form-"+n,target:"video-iframe-"+n});t.find(".js-standart-file-input").on("change",u._prepareThread);i.standartUploadBlock.append(t)}return t},_prepareThread:function(){var c=$(this).val(),u,e,h,s;if(c==""||typeof c=="undefined")return!1;try{yaCounter18545545&&yaCounter18545545.reachGoal&&yaCounter18545545.reachGoal("main_dl")}catch(a){}for(u=new p($(this)),e=n.length,n.push(u),h=0,s=0;s<n.length;s++)n[s].status==t.started&&h++;return h<r.downloadsCount?(l(e,u.name,u.size),o.uploadFile(e),i.threadIndex=e):y(e,u.name,u.size),f(),!0},_runProgress:function(t,i,r){var e=n[t];if(r++,typeof XDomainRequest=="function"){var f=new XDomainRequest,s=function(){var n=JSON.parse(this.responseText);u._treatmentResponse(t,n,i,r)},o=function(){u._uploadError()};f.open("GET",e.uploadUrl+"/"+e.uploadId+"?r="+Math.floor(Math.random(1,1e7)*1e7));f.onprogress=function(){};f.timeout=2e4;f.ontimeout=o;f.onload=s;f.onerror=o;setTimeout(function(){f.send()},0);return}$.ajax({url:e.uploadUrl+"/"+e.uploadId+"?r="+Math.floor(Math.random(1,1e7)*1e7),dataType:"json",contentType:"text/plain",success:function(n){u._treatmentResponse(t,n,i,r)},error:function(){u._uploadError(t)}})},_treatmentResponse:function(i,r,e,o){var h=n[i];if(r.IsGetStatusError)u._uploadError(i);else switch(r.status){case"NotStarted":e<10?(e++,u._runProgress(i,e,o)):u._uploadError(i);break;case"InProcess":w(h.name,i,r.percent,r.totalSize);h.size=r.totalSize;u._runProgress(i,e,o);break;case"Success":h.status=t.complete;h.uploaded=!0;b(i,r.totalSize,h.uploadId);break;case"Close":h.status=t.deleted;s(i);f();break;default:u._uploadError(i)}},_uploadError:function(i){var r=n[i];r.status=t.error;h(i,r.name);f()},uploadFile:function(i){var r=n[i],f;l(i,r.name,r.size);f=v(r);f.done(function(){r.startDate=new Date;r.status=t.started;var n=u._prepareForm(i);n.show().attr({action:r.uploadUrl+"?id="+r.uploadId+"&name="+encodeURI(r.name),enctype:"multipart/form-data",method:"post"});u._runProgress(i,0,0);n.submit()})},cancelUpload:function(i){var r=n[i];r.complete?(r.status=t.deleted,s(i)):$.ajax({url:r.uploadUrl+"/"+r.uploadId,type:"PUT",dataType:"json",contentType:"application/json; charset=utf-8",success:function(){r.status=t.deleted;s(i);f()},error:function(){r.status=t.error;h(i,r.name);f()}})}});var w=function(n,t,i,r){var f=$("#video-"+t+"[data-type=upload]"),u;f.length||(f=l(t,n,r));f.find(".js-progress-val").css("width",i+"%");i=i.toLocaleString();u=i.indexOf(",");u=u<=0?i.indexOf("."):u;u>0&&(i=i.substring(0,u));f.find(".js-percent-container").text(i);f.find(".js-size-container").text(Math.floor(r/1024)+" Kb")},b=function(t,i,u){try{yaCounter18545545&&yaCounter18545545.reachGoal&&yaCounter18545545.reachGoal("un_video_add")}catch(h){}var o=$("#video-"+t),e=o.find(".js-file-name-container").text(),s=k(t,e,i);$.ajax({url:r.updateVideoUrl,type:"post",data:{upload_id:n[t].uploadId,title:e}});g(s,u);f()},ut=function(){var r,u,i;for(tt.text(n.length),r=0,u=0,i=0;i<n.length;i++)n[i].status==t.error?r++:n[i].status==t.complete&&u++;rt.text(r);it.text(u)},s=function(t){var u=$("#video-"+t),f=n[t].name,r=i.uploadDeletedTemplate.clone().attr({"data-type":"deleted",id:"video-"+t});return r.find(".js-file-name-container").text(f),u.length?u.replaceWith(r):i.multiUploadBlock.append(r),r},y=function(n,t){var u=$("#video-"+n),r=i.uploadWaitTemplate.clone().attr({"data-type":"wait",id:"video-"+n});return r.find(".js-file-name-container").text(t),u.length>0?u.replaceWith(r):i.multiUploadBlock.append(r),r},l=function(n,t,r){var f=$("#video-"+n),u=i.multiUploadTemplate.clone().attr({"data-type":"upload",id:"video-"+n});return u.find(".js-file-name-container").text(t),u.find(".js-size-container").text(Math.floor(r/1024)+" Kb"),f.length>0?f.replaceWith(u):i.multiUploadBlock.append(u),u},k=function(n,t,r){var f=$("#video-"+n),u=i.uploadFinishedTemplate.clone().attr({"data-type":"finish",id:"video-"+n});return u.find(".js-file-name-container").text(t),u.find(".js-size-container").text(Math.floor(r/1024)+" Kb"),f.length?f.replaceWith(u):i.multiUploadBlock.append(u),u},h=function(n,t,r){var f=$("#video-"+n),u=i.uploadErrorTemplate.clone().attr({"data-type":"error",id:"video-"+n});return u.find(".js-file-name-container").text(t),r&&(u.find(".js-upload-restore-btn").hide(),u.find(".js-size-error").removeClass("nodisplay")),f.length>0?f.replaceWith(u):i.multiUploadBlock.append(u),u},ft=function(i){if(n[i].uploaded){n[i].status=t.complete;var r=k(i,n[i].name,n[i].size);g(r,n[i].uploadId)}else n[i].status=t.unstarted,y(i,n[i].name,n[i].size),f()},d=function(i,u){var f=n[i];/^\s*$/.test(u)||typeof u=="undefined"?u=f.name:(f.name=u,f.status==t.complete&&$.ajax({url:r.updateVideoUrl,type:"post",data:{upload_id:f.uploadId,title:u}}));et(i,u)},et=function(n,t){var i=$("#video-"+n);i.find(".js-file-name-container").text(t);i.find(".js-file-name").show();i.find(".js-file-name-input-container").hide()},g=function(n,t){$.ajax({url:r.getVideoLinkUrl+"?upload_id="+t,type:"get",success:function(t){ot(t,n)}})},ot=function(n,t){var i,u,f;if(typeof n.VideoLink=="string"&&n.VideoLink.length>0&&(i=t.find(".js-copy-direct-link").show()),typeof n.PlayerLink=="string"&&n.PlayerLink.length>0&&(u=t.find(".js-copy-iframe-link").show()),typeof n.EmbedLink=="string"&&n.EmbedLink.length>0&&(f=t.find(".js-copy-embed-link").show()),st())$get(r.zclipPath),i&&i.zclip({path:r.zclipPath+"?v=1",copy:function(){return n.VideoLink},afterCopy:function(){var t=i.parents(".js-copy-link-container").find(".js-copy-tooltip");t.fadeIn("fast",function(){setTimeout(function(){t.fadeOut("fast")},1e3)});c(!0,i.text(),n.VideoLink)}}),u&&u.zclip({path:r.zclipPath+"?v=2",copy:function(){return n.PlayerLink},afterCopy:function(){var t=u.parents(".js-copy-link-container").find(".js-copy-tooltip");t.fadeIn("fast",function(){setTimeout(function(){t.fadeOut("fast")},1e3)});c(!0,u.text(),n.PlayerLink)}}),f&&f.zclip({path:r.zclipPath+"?v=3",copy:function(){return n.EmbedLink},afterCopy:function(){var t=f.parents(".js-copy-link-container").find(".js-copy-tooltip");t.fadeIn("fast",function(){setTimeout(function(){t.fadeOut("fast")},1e3)});c(!0,f.text(),n.EmbedLink)}}),t.parent().find(".zclip").css({left:"0px",top:"0px"});else{if(i)i.on("click",function(){c(!1,i.text(),n.VideoLink)});if(u)u.on("click",function(){c(!1,u.text(),n.PlayerLink)});if(f)f.on("click",function(){c(!1,f.text(),n.EmbedLink)})}},c=function(n,t,r){var u=i.copyLinkBlock;n?u.find(".js-copy-to-clip-mes").show():u.find(".js-copy-to-clip-mes").hide();u.find(".js-link-type").text(t);u.find(".js-link-code").val(r);u.show("fast",function(){n||u.find(".js-link-code").select()})},f=function(){for(var f=0,e=0,u,i=0;i<n.length;i++)n[i].status==t.started?f++:(n[i].status==t.complete||n[i].status==t.error||n[i].status==t.deleted)&&e++;if(ut(),u=r.downloadsCount-f,u>0)for(i=0;i<n.length;i++)if(n[i].status==t.unstarted&&typeof n[i]!="undefined"&&(o.uploadFile(i),u--),u<=0)break},st=function(){var n=!1,t;return navigator.plugins?navigator.plugins["Shockwave Flash"]?n=!0:navigator.plugins["Shockwave Flash 2.0"]&&(n=!0):navigator.mimeTypes?(t=navigator.mimeTypes["application/x-shockwave-flash"],t&&t.enabledPlugin&&(n=!0)):n=!0,n}}